<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SuperFly | My Account</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">

    <style>
        @font-face { font-family: 'Nourd'; src: url('nourd-bold.woff2') format('woff2'); font-weight: bold; }
        :root { --bg: #ffffff; --text: #1d1d1f; --gray: #86868b; --accent: #000000; --nourd: 'Nourd', sans-serif; }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-font-smoothing: antialiased; }
        body { font-family: 'Inter', sans-serif; background: #f5f5f7; color: var(--text); padding-bottom: 110px; overflow-x: hidden; }

        header { background: var(--bg); padding: 20px 24px; border-bottom: 1px solid rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
        .header-title { font-family: var(--nourd); font-size: 0.8rem; letter-spacing: 2px; text-transform: uppercase; }

        /* --- NOTIF DOT --- */
        .notif-dot { 
            position: absolute; top: -2px; right: -2px; 
            width: 10px; height: 10px; background: #ff3b30; 
            border-radius: 50%; border: 2px solid #fff; 
            display: none; 
        }

        /* --- SETTINGS SIDEBAR --- */
        .sidebar-overlay { position: fixed; top: 0; right: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 2000; display: none; backdrop-filter: blur(4px); }
        .sidebar { position: fixed; top: 0; right: -300px; width: 300px; height: 100%; background: white; z-index: 2001; transition: 0.4s cubic-bezier(0.2, 1, 0.3, 1); padding: 30px 24px; box-shadow: -10px 0 30px rgba(0,0,0,0.1); }
        .sidebar.active { right: 0; }
        .sidebar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px; }
        .sidebar-header h2 { font-family: var(--nourd); font-size: 1rem; text-transform: uppercase; }
        
        .side-menu-item { display: flex; align-items: center; gap: 15px; padding: 18px 0; border-bottom: 1px solid #f5f5f7; cursor: pointer; font-size: 0.95rem; font-weight: 500; position: relative; }
        .side-menu-item i { width: 20px; text-align: center; color: var(--gray); }
        .side-notif-text { color: #ff3b30; font-size: 0.7rem; font-weight: 800; margin-left: auto; display: none; }

        /* PROFILE CARD */
        .profile-card { background: white; padding: 40px 24px; text-align: center; margin-bottom: 1px; }
        .avatar-container { position: relative; width: 100px; height: 100px; margin: 0 auto 15px; }
        .avatar-circle { width: 100%; height: 100%; background: var(--accent); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-family: var(--nourd); font-size: 2.5rem; overflow: hidden; border: 3px solid #fff; box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .avatar-circle img { width: 100%; height: 100%; object-fit: cover; display: none; }
        .upload-icon { position: absolute; bottom: 0; right: 0; background: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 1px solid #ddd; cursor: pointer; color: var(--accent); }

        .user-name { font-family: var(--nourd); font-size: 1.4rem; text-transform: uppercase; margin-bottom: 4px; }
        .edit-btn { background: none; border: 1px solid #ddd; padding: 6px 16px; border-radius: 20px; font-size: 0.7rem; font-weight: 600; cursor: pointer; color: var(--gray); margin-top: 10px; }

        /* STATS */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; background: white; border-top: 1px solid #f5f5f7; margin-bottom: 10px; }
        .stat-box { padding: 20px; text-align: center; border-right: 1px solid #f5f5f7; }
        .stat-value { font-weight: 800; font-size: 1.1rem; display: block; }
        .stat-label { font-size: 0.7rem; color: var(--gray); text-transform: uppercase; margin-top: 4px; }

        /* MENU GROUPS */
        .section-label { padding: 25px 24px 10px; font-family: var(--nourd); font-size: 0.7rem; color: var(--gray); letter-spacing: 1.5px; text-transform: uppercase; }
        .menu-group { background: white; border-top: 1px solid #f5f5f7; }
        .menu-item { display: flex; justify-content: space-between; align-items: center; padding: 18px 24px; border-bottom: 1px solid #f5f5f7; cursor: pointer; }
        .menu-link { display: flex; align-items: center; gap: 15px; font-weight: 500; font-size: 0.95rem; }
        .badge { background: #f5f5f7; color: black; font-size: 0.7rem; font-weight: 800; padding: 4px 10px; border-radius: 10px; }

        /* CROPPER MODAL */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 9999; flex-direction: column; align-items: center; justify-content: center; }
        .cropper-container { width: 90%; max-height: 70vh; margin-bottom: 30px; position: relative; }
        .cropper-container img { max-width: 100%; display: block; }
        .crop-actions { display: flex; gap: 40px; position: absolute; bottom: -100px; width: 100%; justify-content: center; }
        .circle-action-btn { width: 70px; height: 70px; border-radius: 50%; border: none; font-size: 1.8rem; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 5px 15px rgba(0,0,0,0.3); transition: 0.2s; }
        .btn-cancel { background: #ff3b30; color: white; }
        .btn-save { background: #34c759; color: white; }

        /* NAV */
        nav { position: fixed; bottom: 0; width: 100%; background: rgba(255,255,255,0.85); backdrop-filter: blur(15px); display: flex; justify-content: space-around; padding: 12px 0 28px; border-top: 1px solid rgba(0,0,0,0.05); z-index: 1000; }
        nav a { text-decoration: none; font-size: 0.65rem; text-align: center; color: var(--gray); position: relative; }
        nav a.active { color: var(--accent); }
        nav i { display: block; font-size: 1.2rem; margin-bottom: 4px; }
    </style>
</head>
<body>

    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h2>Settings</h2>
            <i class="fa-solid fa-xmark" onclick="toggleSidebar()" style="cursor:pointer; font-size: 1.5rem;"></i>
        </div>
        <div class="side-menu-item" onclick="goToNotif()">
            <i class="fa-solid fa-bell"></i> Notifications
            <span id="sideNotifDot" class="side-notif-text">NEW</span>
        </div>
        <div class="side-menu-item" onclick="window.location.href='privacy.html'">
            <i class="fa-solid fa-shield-halved"></i> Privacy
        </div>
        <div class="side-menu-item" onclick="window.location.href='security.html'">
            <i class="fa-solid fa-lock"></i> Security
        </div>
        <div class="side-menu-item" onclick="window.location.href='help.html'">
            <i class="fa-solid fa-circle-question"></i> Help
        </div>
        <div style="margin-top: 40px; color: #ccc; font-size: 0.6rem; letter-spacing: 1px;">SUPERFLY V1.0.4 PRO</div>
    </div>

    <header>
        <div style="width: 24px;"></div>
        <div class="header-title">Account</div>
        <div style="position: relative;">
            <i class="fa-solid fa-gear" onclick="toggleSidebar()" style="cursor: pointer; font-size: 1.2rem;"></i>
            <div id="gearDot" class="notif-dot"></div> </div>
    </header>

    <div class="profile-card">
        <div class="avatar-container">
            <div class="avatar-circle" id="avatarCircle">
                <span id="userInitial">?</span>
                <img id="userImg" src="" alt="Profile">
            </div>
            <label for="fileInput" class="upload-icon"><i class="fa-solid fa-camera"></i></label>
            <input type="file" id="fileInput" style="display: none;" accept="image/*">
        </div>
        <h2 class="user-name" id="userName">Loading...</h2>
        <p id="userEmail" style="color:var(--gray); font-size: 0.9rem;">...</p>
        <button class="edit-btn" onclick="openEditModal()">EDIT NAME</button>
    </div>

    <div class="stats-grid">
        <div class="stat-box"><span class="stat-value">08</span><span class="stat-label">Orders</span></div>
        <div class="stat-box"><span class="stat-value">Elite</span><span class="stat-label">Member</span></div>
    </div>

    <div class="section-label">General</div>
    <div class="menu-group">
        <div class="menu-item" onclick="window.location.href='orders.html'"><div class="menu-link"><i class="fa-solid fa-box-open"></i> My Orders</div><i class="fa-solid fa-chevron-right" style="color:#ccc"></i></div>
        <div class="menu-item" onclick="window.location.href='wishlist.html'"><div class="menu-link"><i class="fa-solid fa-heart"></i> My Wishlist</div><div style="display:flex;align-items:center;gap:10px;"><span id="wishCount" class="badge">0</span><i class="fa-solid fa-chevron-right" style="color:#ccc"></i></div></div>
    </div>

    <div class="section-label">System</div>
    <div class="menu-group">
        <div class="menu-item" id="logoutBtn"><div class="menu-link" style="color:#ff3b30"><i class="fa-solid fa-right-from-bracket"></i> Logout</div></div>
    </div>

    <div id="cropperModal" class="modal-overlay">
        <div class="cropper-container"><img id="imageToCrop"><div class="crop-actions"><button onclick="closeCropper()" class="circle-action-btn btn-cancel"><i class="fa-solid fa-xmark"></i></button><button id="saveCropBtn" class="circle-action-btn btn-save"><i class="fa-solid fa-check"></i></button></div></div>
    </div>

    <div id="editModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999; align-items:center; justify-content:center; padding:20px;">
        <div style="background:white; padding:30px; border-radius:24px; width:100%; max-width:400px; text-align:center;">
            <h3 style="font-family:'Nourd'">UPDATE NAME</h3>
            <input type="text" id="newNameInput" style="width:100%; padding:15px; border:1px solid #ddd; border-radius:12px; margin:20px 0;">
            <div style="display:flex; gap:10px;"><button onclick="closeEditModal()" style="flex:1; padding:15px; border-radius:12px; border:none;">Cancel</button><button id="saveNameBtn" style="flex:1; padding:15px; border-radius:12px; border:none; background:black; color:white;">Save</button></div>
        </div>
    </div>

    <nav>
        <a href="main.html"><i class="fa-solid fa-house"></i>Home</a>
        <a href="cart.html"><i class="fa-solid fa-cart-shopping"></i>Cart</a>
        <a href="#" class="active"><i class="fa-solid fa-user"></i>Account<div id="navDot" class="notif-dot"></div></a>
    </nav>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAWLyrAPqCTJ7hXgc6D7wW_ePBbJXMG01k",
            authDomain: "superfly-project.firebaseapp.com",
            projectId: "superfly-project",
            storageBucket: "superfly-project.firebasestorage.app",
            messagingSenderId: "197736732141",
            appId: "1:197736732141:web:4967ee0e29f8ba17dc43e4"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        let cropper;

        // --- SIDEBAR LOGIC ---
        window.toggleSidebar = () => {
            const sb = document.getElementById('sidebar');
            const ov = document.getElementById('sidebarOverlay');
            if(sb.classList.contains('active')) {
                sb.classList.remove('active');
                setTimeout(() => ov.style.display = 'none', 400);
            } else {
                ov.style.display = 'block';
                setTimeout(() => sb.classList.add('active'), 10);
            }
        };

        // --- NOTIF LOGIC ---
        function checkUnreadNotifs() {
            const isUnread = localStorage.getItem('sf_notif_unread') === 'true';
            if(isUnread) {
                document.getElementById('gearDot').style.display = 'block';
                document.getElementById('navDot').style.display = 'block';
                document.getElementById('sideNotifDot').style.display = 'block';
            }
        }
        window.goToNotif = () => {
            window.location.href = 'notification.html';
        };

        onAuthStateChanged(auth, (user) => {
            if (user) { 
                updateUI(user); 
                updateWishCount(); 
                checkUnreadNotifs();
            } else { 
                window.location.href = 'index.html'; 
            }
        });

        function updateUI(user) {
            const name = user.displayName || "Elite User";
            document.getElementById('userName').innerText = name;
            document.getElementById('userEmail').innerText = user.email;
            const localPic = localStorage.getItem('user_pfp_' + user.uid);
            if (localPic) {
                document.getElementById('userImg').src = localPic;
                document.getElementById('userImg').style.display = 'block';
                document.getElementById('userInitial').style.display = 'none';
            } else {
                document.getElementById('userInitial').innerText = name.charAt(0).toUpperCase();
                document.getElementById('userInitial').style.display = 'block';
                document.getElementById('userImg').style.display = 'none';
            }
        }

        // CROPPER LOGIC
        document.getElementById('fileInput').onchange = (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = document.getElementById('imageToCrop');
                    img.src = event.target.result;
                    document.getElementById('cropperModal').style.display = 'flex';
                    if (cropper) cropper.destroy();
                    cropper = new Cropper(img, { aspectRatio: 1, viewMode: 1, dragMode: 'move', background: false });
                };
                reader.readAsDataURL(file);
            }
        };

        document.getElementById('saveCropBtn').onclick = () => {
            const canvas = cropper.getCroppedCanvas({ width: 400, height: 400 });
            localStorage.setItem('user_pfp_' + auth.currentUser.uid, canvas.toDataURL('image/jpeg'));
            updateUI(auth.currentUser);
            closeCropper();
        };

        window.closeCropper = () => { document.getElementById('cropperModal').style.display = 'none'; };
        window.openEditModal = () => document.getElementById('editModal').style.display = 'flex';
        window.closeEditModal = () => document.getElementById('editModal').style.display = 'none';

        document.getElementById('saveNameBtn').onclick = async () => {
            const newName = document.getElementById('newNameInput').value;
            if (auth.currentUser && newName.trim() !== "") {
                await updateProfile(auth.currentUser, { displayName: newName });
                updateUI(auth.currentUser);
                closeEditModal();
            }
        };

        // --- PERBAIKAN WISHCOUNT SINKRONISASI ---
        function updateWishCount() {
            // Ambil data dari sf_wishlist atau fallback ke array kosong
            const wishlist = JSON.parse(localStorage.getItem('sf_wishlist')) || [];
            
            // Jika lo merasa produk di keranjang harusnya masuk wishlist juga,
            // lo bisa aktifkan baris di bawah (opsional):
            // const cart = JSON.parse(localStorage.getItem('cart')) || [];
            // const totalCount = wishlist.length || cart.length; 

            const badge = document.getElementById('wishCount');
            if (badge) {
                badge.innerText = wishlist.length;
            }
        }

        // Tambahkan event listener agar setiap kali tab aktif, angka terupdate
        window.addEventListener('focus', updateWishCount);

        document.getElementById('logoutBtn').onclick = () => signOut(auth);
    </script>
</body>
</html>
